
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0"
    />
    <title>PLAYTEST - Block Questions</title>

    <!-- Embedded Global Stylesheet -->
    <style>
      body {
        font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto,
          Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
      }
      .animate-fade-in { animation: fadeIn 0.5s ease-in-out; }
      @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
      ::-webkit-scrollbar { width: 8px; height: 8px; }
      ::-webkit-scrollbar-track { background: #1B263B; border-radius: 10px; }
      ::-webkit-scrollbar-thumb { background: #415A77; border-radius: 10px; }
      ::-webkit-scrollbar-thumb:hover { background: #778DA9; }
      * { scrollbar-width: thin; scrollbar-color: #415A77 #1B263B; }
      input[type='range'] { -webkit-appearance: none; appearance: none; background-color: transparent; cursor: pointer; width: 100%; }
      input[type='range']::-webkit-slider-runnable-track { height: 0.5rem; background: #415A77; border-radius: 0.5rem; }
      input[type='range']::-moz-range-track { height: 0.5rem; background: #415A77; border-radius: 0.5rem; }
      input[type='range']::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; margin-top: -6px; background-color: #3b82f6; height: 20px; width: 20px; border-radius: 50%; }
      input[type='range']::-moz-range-thumb { border: none; background-color: #3b82f6; height: 20px; width: 20px; border-radius: 50%; }
    </style>

    <!-- Tailwind CSS from CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              'brand-primary': '#0D1B2A',
              'brand-secondary': '#1B263B',
              'brand-tertiary': '#415A77',
              'brand-accent': '#778DA9',
              'brand-light': '#E0E1DD',
              'brand-cta': '#3B82F6',
              'brand-cta-hover': '#2563EB',
              'brand-success': '#10B981',
              'brand-danger': '#EF4444',
            },
          },
        },
      };
    </script>

    <!-- Import Map to resolve bare module specifiers for React -->
    <script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@18.2.0",
    "react/jsx-runtime": "https://esm.sh/react@18.2.0/jsx-runtime",
    "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
    "react-dom/": "https://esm.sh/react-dom@18.2.0/",
    "react/": "https://esm.sh/react@18.2.0/"
  }
}
</script>
  </head>
  <body class="bg-brand-primary text-brand-light">
    <div id="root"></div>

    <!-- Babel Standalone for in-browser transpilation of TSX/JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Main application script -->
    <script type="text/babel" data-type="module">
      import React, { useState, useEffect, useCallback, useMemo, useRef, createContext, useContext } from 'react';
      import ReactDOM from 'react-dom/client';

      // --- INLINED: i18n ---
      const translations = {
        es: {
          header_title: 'Aplicación PLAYTEST', header_subtitle: 'La forma más divertida de estudiar', language: 'Idioma', english: 'Inglés', spanish: 'Español',
          all_blocks_return: 'Volver', 
          block_questions_filter_topic: 'Filtrar por tema', block_questions_all_topics: 'Todos los Temas', block_questions_count: '{count} Preguntas', block_questions_none: 'No se han encontrado preguntas para este tema.', block_questions_none_tip: 'Selecciona "Todos los Temas" para ver todas las preguntas o añadir nuevas.', block_questions_topic: 'Tema', block_questions_button_save: 'Guardar', block_questions_saving: 'Guardando...', block_questions_button_delete: 'Eliminar',
          generator_difficulty: 'Dificultad', generator_explanation: 'Explicación',
          uploader_question_text: 'Texto de la Pregunta', uploader_answers: 'Respuestas', uploader_button_edit: 'Editar',
          delete_question_confirm: '¿Estás seguro de que quieres eliminar esta pregunta? Esta acción no se puede deshacer.', delete_question_prompt_title: 'Borrar la pregunta',
          delete_question_prompt_confirm: 'SI', delete_question_prompt_cancel: 'NO',
          generic_cancel: 'Cancelar', error: 'Error', loading: 'Cargando...',
          footer_text: '© 2024 PLAYTEST. Todos los derechos reservados.',
        },
        en: {
          header_title: 'PLAYTEST App', header_subtitle: 'The most fun way to study', language: 'Language', english: 'English', spanish: 'Spanish',
          all_blocks_return: 'Return',
          block_questions_filter_topic: 'Filter by topic', block_questions_all_topics: 'All Topics', block_questions_count: '{count} Questions', block_questions_none: 'No questions found for this topic.', block_questions_none_tip: 'Select "All Topics" to see all questions or add new ones.', block_questions_topic: 'Topic', block_questions_button_save: 'Save', block_questions_saving: 'Saving...', block_questions_button_delete: 'Delete',
          generator_difficulty: 'Difficulty', generator_explanation: 'Explanation',
          uploader_question_text: 'Question Text', uploader_answers: 'Answers', uploader_button_edit: 'Edit',
          delete_question_confirm: 'Are you sure you want to delete this question? This action cannot be undone.', delete_question_prompt_title: 'Delete Question',
          delete_question_prompt_confirm: 'YES', delete_question_prompt_cancel: 'NO',
          generic_cancel: 'Cancel', error: 'Error', loading: 'Loading...',
          footer_text: '© 2024 PLAYTEST. All rights reserved.',
        }
      };
      const LanguageContext = createContext();
      const LanguageProvider = ({ children }) => {
        const [language, setLanguage] = useState(() => localStorage.getItem('playtest_lang') || 'es');
        useEffect(() => { localStorage.setItem('playtest_lang', language); }, [language]);
        const t = useCallback((key, replacements = {}) => {
            let translation = (translations[language] && translations[language][key]) || (translations['en'] && translations['en'][key]) || key;
            Object.keys(replacements).forEach(placeholder => {
                translation = translation.replace(`{${placeholder}}`, replacements[placeholder]);
            });
            return translation;
        }, [language]);
        return <LanguageContext.Provider value={{ language, setLanguage, t }}>{children}</LanguageContext.Provider>;
      };
      const useLanguage = () => useContext(LanguageContext);

      // --- INLINED: components/icons.tsx ---
      const ArrowLeftIcon = (props) => ( <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" {...props}> <path strokeLinecap="round" strokeLinejoin="round" d="M10.5 19.5L3 12m0 0l7.5-7.5M3 12h18" /> </svg> );
      const PencilIcon = (props) => ( <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" {...props}> <path strokeLinecap="round" strokeLinejoin="round" d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L6.832 19.82a4.5 4.5 0 01-1.897 1.13l-2.685.8.8-2.685a4.5 4.5 0 011.13-1.897L16.863 4.487zm0 0L19.5 7.125" /> </svg> );
      const TrashIcon = (props) => ( <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" {...props}> <path strokeLinecap="round" strokeLinejoin="round" d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 013.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 00-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 00-7.5 0" /> </svg> );
      const SaveIcon = (props) => ( <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" {...props}> <path strokeLinecap="round" strokeLinejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3" /> </svg> );
      const CheckCircleIcon = (props) => ( <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor" {...props}> <path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clipRule="evenodd" /> </svg> );
      const XCircleIcon = (props) => ( <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor" {...props}> <path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clipRule="evenodd" /> </svg> );
      const XMarkIcon = (props) => ( <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" {...props}> <path strokeLinecap="round" strokeLinejoin="round" d="M6 18L18 6M6 6l12 12" /> </svg> );
      const ChevronUpDownIcon = (props) => ( <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" {...props}> <path strokeLinecap="round" strokeLinejoin="round" d="M8.25 15L12 18.75 15.75 15m-7.5-6L12 5.25 15.75 9" /> </svg> );

      // --- INLINED: services/dataService.ts ---
      const DB_KEY = 'playtest_db_v3';
      const getDatabase = () => {
          const dbString = localStorage.getItem(DB_KEY);
          return dbString ? JSON.parse(dbString) : { users: [], globalBlocks: [], globalQuestions: [], userProfiles: {} };
      };
      const saveDatabase = (db) => {
          localStorage.setItem(DB_KEY, JSON.stringify(db));
      };
      const simulateDelay = (data, delay = 50) => new Promise(resolve => setTimeout(() => resolve(JSON.parse(JSON.stringify(data))), delay));

      const fetchBlockById = async (blockId) => {
          const db = getDatabase();
          const block = (db.globalBlocks || []).find(b => b.id === blockId);
          if (!block) return null;
          const questions = (db.globalQuestions || []).filter(q => q.bloqueId === blockId);
          return simulateDelay({ ...block, questions });
      };

      const updateQuestion = async (updatedQuestion) => {
          const db = getDatabase();
          if (!updatedQuestion.id) throw new Error('Question ID is required.');
          const qIndex = db.globalQuestions.findIndex(q => q.id === updatedQuestion.id);
          if (qIndex === -1) throw new Error('Question not found.');
          db.globalQuestions[qIndex] = { ...db.globalQuestions[qIndex], ...updatedQuestion };
          saveDatabase(db);
          return simulateDelay(db.globalQuestions[qIndex]);
      };

      const deleteQuestion = async (questionId) => {
          const db = getDatabase();
          const qIndex = db.globalQuestions.findIndex(q => q.id === questionId);
          if (qIndex === -1) throw new Error('Question not found.');
          const { bloqueId } = db.globalQuestions[qIndex];
          db.globalQuestions.splice(qIndex, 1);
          
          const remainingInBlock = db.globalQuestions
              .filter(q => q.bloqueId === bloqueId)
              .sort((a, b) => (a.numero || 0) - (b.numero || 0));

          remainingInBlock.forEach((q, index) => {
              const original = db.globalQuestions.find(orig => orig.id === q.id);
              if(original) original.numero = index + 1;
          });
          
          saveDatabase(db);
          return simulateDelay({ message: 'Question deleted.' });
      };

      // --- INLINED: components ---
      const ConfirmationDialog = ({ title, message, confirmText, cancelText, onConfirm, onCancel, danger = false }) => (
        <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 animate-fade-in" onClick={onCancel}>
          <div className={`bg-brand-secondary rounded-xl shadow-2xl w-full max-w-sm m-4 border ${danger ? 'border-brand-danger/50' : 'border-brand-tertiary'} p-6 text-center`} onClick={e => e.stopPropagation()}>
              <h4 className="text-xl font-bold text-brand-light">{title}</h4>
              <p className="text-brand-accent my-4">{message}</p>
              <div className="flex justify-center gap-4 mt-6">
                  <button onClick={onCancel} className="py-2 px-6 rounded-lg bg-brand-tertiary hover:bg-brand-accent text-brand-light font-bold transition-colors">{cancelText}</button>
                  <button onClick={onConfirm} className={`py-2 px-6 rounded-lg font-bold transition-colors text-white ${danger ? 'bg-brand-danger hover:bg-red-500' : 'bg-brand-cta hover:bg-brand-cta-hover'}`}>{confirmText}</button>
              </div>
          </div>
        </div>
      );

      const BlockQuestionsView = ({ block, returnUrl, onUpdateQuestion, onDeleteQuestion, isReadOnly }) => {
        const { t } = useLanguage();
        const [editingQuestionId, setEditingQuestionId] = useState(null);
        const [editedQuestion, setEditedQuestion] = useState(null);
        const [topicFilter, setTopicFilter] = useState('all');
        const [isSaving, setIsSaving] = useState(false);
        const [deletingQuestionId, setDeletingQuestionId] = useState(null);
        const [confirmingDeleteId, setConfirmingDeleteId] = useState(null);

        const uniqueTopics = useMemo(() => { const topics = new Set(block.questions?.map(q => q.tema) || []); return ['all', ...Array.from(topics)]; }, [block.questions]);
        const filteredQuestions = useMemo(() => {
          const allQs = block.questions || [];
          
          const questionsToProcess = topicFilter === 'all'
            ? [...allQs]
            : allQs.filter(q => q.tema === topicFilter);

          // Sort by difficulty (ascending), then by original number
          questionsToProcess.sort((a, b) => {
              const diffA = a.dificultad || 0;
              const diffB = b.dificultad || 0;
              if (diffA !== diffB) {
                  return diffA - diffB;
              }
              return (a.numero || 0) - (b.numero || 0);
          });
          
          return questionsToProcess;
        }, [block.questions, topicFilter]);

        const handleEditClick = (question) => { setEditingQuestionId(question.id); setEditedQuestion(JSON.parse(JSON.stringify(question))); };
        const handleCancelClick = () => { setEditingQuestionId(null); setEditedQuestion(null); };
        const handleSaveClick = async () => { if (editedQuestion) { setIsSaving(true); await onUpdateQuestion(editedQuestion); setEditingQuestionId(null); setEditedQuestion(null); setIsSaving(false); } };
        
        const handleConfirmDelete = async () => {
          if (confirmingDeleteId) {
            setDeletingQuestionId(confirmingDeleteId);
            const idToDelete = confirmingDeleteId;
            setConfirmingDeleteId(null);
            try {
              await onDeleteQuestion(idToDelete);
            } catch (error) {
              console.error("Failed to delete question:", error);
            } finally {
              setDeletingQuestionId(null);
            }
          }
        };
        
        const onReturn = () => { window.location.href = returnUrl || 'index.html'; };

        const handleFormChange = (e) => { if (!editedQuestion) return; const { name, value } = e.target; setEditedQuestion({ ...editedQuestion, [name]: name === 'dificultad' ? parseInt(value, 10) : value }); };
        const handleAnswerTextChange = (index, text) => { if (!editedQuestion) return; const newAnswers = [...editedQuestion.respuestas]; newAnswers[index].textoRespuesta = text; setEditedQuestion({ ...editedQuestion, respuestas: newAnswers }); };
        const handleCorrectAnswerChange = (index) => { if (!editedQuestion) return; const newAnswers = editedQuestion.respuestas.map((ans, i) => ({ ...ans, esCorrecta: i === index, })); setEditedQuestion({ ...editedQuestion, respuestas: newAnswers }); };

        return (
          <div className="bg-brand-secondary p-6 rounded-xl shadow-lg animate-fade-in">
            {confirmingDeleteId && (
                <ConfirmationDialog
                    title={t('delete_question_prompt_title')}
                    message={t('delete_question_confirm')}
                    confirmText={t('delete_question_prompt_confirm')}
                    cancelText={t('delete_question_prompt_cancel')}
                    onConfirm={handleConfirmDelete}
                    onCancel={() => setConfirmingDeleteId(null)}
                    danger={true}
                />
            )}
            <div className="flex flex-col sm:flex-row items-start sm:items-center justify-between mb-6 border-b border-brand-tertiary pb-4 gap-4">
              <div className="flex items-center gap-4"> <button onClick={onReturn} className="flex items-center gap-2 bg-brand-tertiary hover:bg-brand-accent text-brand-light font-semibold py-2 px-4 rounded-lg transition-colors" aria-label="Return to previous page"> <ArrowLeftIcon className="h-5 w-5" /> <span>{t('all_blocks_return')}</span> </button> <div className="flex items-center gap-4"> <img src={block.urlImagenBloque} alt={block.nombreCorto} className="h-12 w-20 rounded-lg object-cover" /> <div> <h2 className="text-2xl font-bold text-brand-light">{block.nombreCorto}</h2> <p className="text-sm text-brand-accent">{block.nombreLargo}</p> </div> </div> </div>
              <div className="w-full sm:w-auto flex flex-col sm:flex-row items-stretch sm:items-center gap-2"> <select value={topicFilter} onChange={(e) => setTopicFilter(e.target.value)} className="w-full sm:w-48 bg-brand-primary border border-brand-tertiary rounded-lg px-3 py-2 text-brand-light focus:ring-2 focus:ring-brand-cta focus:outline-none" aria-label={t('block_questions_filter_topic')}> {uniqueTopics.map(topic => ( <option key={topic} value={topic}>{topic === 'all' ? t('block_questions_all_topics') : topic}</option> ))} </select> <span className="text-sm text-center font-medium text-brand-accent bg-brand-primary px-3 py-2 rounded-lg">{t('block_questions_count', {count: filteredQuestions.length})}</span> </div>
            </div>
            <div className="space-y-4">
              {filteredQuestions.length > 0 ? ( filteredQuestions.map((q, qIndex) => (
                <div key={q.id || qIndex}>
                  {editingQuestionId === q.id ? (
                    <div className="bg-brand-primary p-4 rounded-lg border-2 border-brand-cta animate-fade-in"> <div className="space-y-4"> <div> <label className="text-sm font-medium text-brand-accent">{t('uploader_question_text')}</label> <textarea name="textoPregunta" value={editedQuestion?.textoPregunta} onChange={handleFormChange} rows={3} className="mt-1 w-full bg-brand-secondary border border-brand-tertiary rounded-lg px-3 py-2 text-brand-light focus:ring-2 focus:ring-brand-cta focus:outline-none" /> </div> <div> <label className="text-sm font-medium text-brand-accent">{t('uploader_answers')}</label> <div className="mt-1 space-y-2"> {editedQuestion?.respuestas.map((ans, idx) => ( <div key={idx} className="flex items-center gap-2"> <input type="radio" name={`correctAnswer-${q.id}`} checked={ans.esCorrecta} onChange={() => handleCorrectAnswerChange(idx)} className="h-4 w-4 text-brand-cta bg-brand-tertiary border-brand-tertiary focus:ring-brand-cta"/><input type="text" value={ans.textoRespuesta} onChange={(e) => handleAnswerTextChange(idx, e.target.value)} className="w-full bg-brand-secondary border border-brand-tertiary rounded-lg px-3 py-2 text-brand-light focus:ring-2 focus:ring-brand-cta focus:outline-none"/> </div> ))} </div> </div> <div> <label className="text-sm font-medium text-brand-accent">{t('generator_explanation')}</label> <textarea name="explicacionRespuesta" value={editedQuestion?.explicacionRespuesta} onChange={handleFormChange} rows={2} className="mt-1 w-full bg-brand-secondary border border-brand-tertiary rounded-lg px-3 py-2 text-brand-light focus:ring-2 focus:ring-brand-cta focus:outline-none" /> </div> <div className="grid grid-cols-2 gap-4"> <div> <label className="text-sm font-medium text-brand-accent">{t('block_questions_topic')}</label> <input name="tema" type="text" value={editedQuestion?.tema} onChange={handleFormChange} className="mt-1 w-full bg-brand-secondary border border-brand-tertiary rounded-lg px-3 py-2 text-brand-light focus:ring-2 focus:ring-brand-cta focus:outline-none" /> </div> <div> <label className="text-sm font-medium text-brand-accent">{t('generator_difficulty')} ({editedQuestion?.dificultad}/5)</label> <input name="dificultad" type="range" min="1" max="5" value={editedQuestion?.dificultad} onChange={handleFormChange} className="mt-1 w-full h-2 bg-brand-tertiary rounded-lg appearance-none cursor-pointer" /> </div> </div> <div className="flex justify-end gap-3 mt-4"> <button onClick={handleCancelClick} className="flex items-center gap-2 bg-brand-tertiary hover:bg-brand-accent text-brand-light font-semibold py-2 px-4 rounded-lg transition-colors"><XMarkIcon className="h-5 w-5"/>{t('generic_cancel')}</button> <button onClick={handleSaveClick} disabled={isSaving} className="flex items-center gap-2 bg-brand-cta hover:bg-brand-cta-hover text-white font-semibold py-2 px-4 rounded-lg transition-colors disabled:bg-brand-tertiary"> {isSaving ? <svg className="animate-spin h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle><path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> : <SaveIcon className="h-5 w-5"/>} {t('block_questions_button_save')} </button> </div> </div> </div>
                  ) : (
                    <div className="bg-brand-primary p-4 rounded-lg border border-brand-tertiary/50"> <div className="flex items-start justify-between gap-4"> <div className="flex items-start gap-3 flex-grow"> <span className="flex-shrink-0 mt-1 w-8 text-center text-lg font-bold text-brand-accent">{q.numero}.</span> <div className="flex-grow"> <p className="font-semibold text-brand-light">{q.textoPregunta}</p> <div className="flex items-center gap-2 mt-1"> <span className="text-xs text-brand-accent">({t('generator_difficulty')}: {q.dificultad}/5)</span> <span className="text-xs font-medium text-brand-light bg-brand-tertiary px-2 py-0.5 rounded-full">{q.tema}</span> </div> </div> </div> <div className="flex-shrink-0 flex items-center gap-2"> {!isReadOnly && (<> <button onClick={() => handleEditClick(q)} className="flex items-center gap-2 bg-brand-tertiary/50 hover:bg-brand-tertiary text-brand-light font-semibold py-1.5 px-3 rounded-lg transition-colors text-sm"> <PencilIcon className="h-4 w-4"/> {t('uploader_button_edit')} </button> <button onClick={() => setConfirmingDeleteId(q.id)} disabled={deletingQuestionId === q.id} className="flex items-center gap-2 bg-brand-danger/20 hover:bg-brand-danger/40 text-brand-danger font-semibold py-1.5 px-3 rounded-lg transition-colors text-sm disabled:opacity-50 disabled:cursor-wait"> {deletingQuestionId === q.id ? ( <svg className="animate-spin h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle><path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> ) : ( <TrashIcon className="h-4 w-4"/> )} <span>{t('block_questions_button_delete')}</span> </button> </>)} </div> </div> 
                    {!isReadOnly && (
                      <>
                        <div className="mt-3 space-y-2 pl-11"> {q.respuestas.map((r, rIndex) => ( <div key={rIndex} className={`flex items-center text-sm rounded-md p-2 ${r.esCorrecta ? 'bg-brand-success/10 text-brand-success' : 'text-brand-accent'}`}> {r.esCorrecta ? <CheckCircleIcon className="h-5 w-5 mr-2 flex-shrink-0" /> : <XCircleIcon className="h-5 w-5 mr-2 flex-shrink-0 text-brand-danger" />} <span>{r.textoRespuesta}</span> </div> ))} </div> 
                        {q.explicacionRespuesta && ( <p className="mt-3 text-xs italic text-brand-accent pl-11 border-l-2 border-brand-tertiary ml-[22px]"> <strong>{t('uploader_explanation')}:</strong> {q.explicacionRespuesta} </p> )}
                      </>
                    )}
                     </div>
                  )}
                </div>
              ))) : ( <div className="text-center py-10"> <p className="text-brand-accent">{t('block_questions_none')}</p> <p className="text-sm text-brand-tertiary mt-2">{t('block_questions_none_tip')}</p> </div> )}
            </div>
          </div>
        );
      };

      const Header = () => {
        const { language, setLanguage, t } = useLanguage();
        const [isDropdownOpen, setIsDropdownOpen] = useState(false);
        const dropdownRef = useRef(null);
        useEffect(() => { const handleClickOutside = (e) => { if (dropdownRef.current && !dropdownRef.current.contains(e.target)) setIsDropdownOpen(false); }; document.addEventListener("mousedown", handleClickOutside); return () => document.removeEventListener("mousedown", handleClickOutside); }, [dropdownRef]);
        return (
          <header className="bg-brand-secondary shadow-lg"><div className="container mx-auto px-4 sm:px-6 lg:px-8"><div className="flex items-center justify-between h-16">
              <div className="flex items-center space-x-3"><img src="./Imagenes/Playtest.png" alt="Playtest Logo" className="h-16 w-16" /><h1 className="text-xl md:text-2xl font-bold tracking-wider text-brand-light">{t('header_title')} <span className="font-light text-brand-accent hidden sm:inline">{t('header_subtitle')}</span></h1></div>
              <div className="relative" ref={dropdownRef}><button onClick={() => setIsDropdownOpen(!isDropdownOpen)} className="flex items-center gap-2 text-brand-accent hover:text-brand-light transition-colors p-2 rounded-md"><span className="font-semibold">{language.toUpperCase()}</span><ChevronUpDownIcon className="h-5 w-5" /></button>
                {isDropdownOpen && (<div className="absolute right-0 mt-2 w-32 bg-brand-primary rounded-md shadow-lg z-20 ring-1 ring-black ring-opacity-5"><div className="py-1"><a href="#" onClick={(e)=>{e.preventDefault();setLanguage('es');setIsDropdownOpen(false);}} className="block px-4 py-2 text-sm text-brand-light hover:bg-brand-tertiary">{t('spanish')}</a><a href="#" onClick={(e)=>{e.preventDefault();setLanguage('en');setIsDropdownOpen(false);}} className="block px-4 py-2 text-sm text-brand-light hover:bg-brand-tertiary">{t('english')}</a></div></div>)}
              </div>
          </div></div></header>
        );
      };

      // --- Main Page Component ---
      const BlockQuestionsPage = () => {
          const { t } = useLanguage();
          const [block, setBlock] = useState(null);
          const [isLoading, setIsLoading] = useState(true);
          const [error, setError] = useState(null);
          const [returnUrl, setReturnUrl] = useState('index.html');
          const [blockId, setBlockId] = useState(null);
          const [isReadOnly, setIsReadOnly] = useState(false);

          const loadBlockData = useCallback(async () => {
            if (!blockId) return;
            try {
              setError(null);
              setIsLoading(true);
              const fetchedBlock = await fetchBlockById(blockId);
              if (!fetchedBlock) throw new Error("Block not found.");
              setBlock(fetchedBlock);
            } catch (err) {
              setError(err.message);
            } finally {
              setIsLoading(false);
            }
          }, [blockId]);

          useEffect(() => {
              const params = new URLSearchParams(window.location.search);
              const id = params.get('blockId');
              const url = params.get('returnUrl');
              const viewMode = params.get('viewMode');
              if (viewMode === 'readonly') {
                  setIsReadOnly(true);
              }
              if (id) setBlockId(id);
              if (url) setReturnUrl(url);
              if (!id) setError("No Block ID provided in URL.");
          }, []);

          useEffect(() => {
            loadBlockData();
          }, [loadBlockData]);

          const handleUpdateQuestion = async (question) => {
              if (isReadOnly) return;
              await updateQuestion(question);
              await loadBlockData();
          };

          const handleDeleteQuestion = async (questionId) => {
              if (isReadOnly) return;
              await deleteQuestion(questionId);
              await loadBlockData();
          };

          const renderContent = () => {
              if (isLoading) { return <div className="flex justify-center items-center h-64"><svg className="animate-spin h-10 w-10 text-brand-cta" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle><path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg></div>; }
              if (error) { return <div className="text-center text-brand-danger bg-red-500/10 p-4 rounded-lg">{t('error')}: {error}</div>; }
              if (!block) { return <div className="text-center text-brand-accent p-8">{t('error')}: Block data could not be loaded.</div>; }
              return <BlockQuestionsView block={block} returnUrl={returnUrl} onUpdateQuestion={handleUpdateQuestion} onDeleteQuestion={handleDeleteQuestion} isReadOnly={isReadOnly} />;
          };
          return (
              <div className="min-h-screen flex flex-col">
                  <Header />
                  <main className="flex-grow p-4 sm:p-6 lg:p-8">{renderContent()}</main>
                  <footer className="text-center p-4 text-xs text-brand-accent"><p>{t('footer_text')}</p></footer>
              </div>
          );
      };

      // --- App Entry Point ---
      const root = ReactDOM.createRoot(document.getElementById('root'));
      root.render(
        <React.StrictMode>
          <LanguageProvider><BlockQuestionsPage /></LanguageProvider>
        </React.StrictMode>
      );
    </script>
    <noscript>This application requires JavaScript to run.</noscript>
  </body>
</html>