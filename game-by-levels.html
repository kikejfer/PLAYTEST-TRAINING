


<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0"
    />
    <title>PLAYTEST - By Levels Mode</title>

    <!-- Embedded Global Stylesheet -->
    <style>
      body {
        font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto,
          Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
      }
      .animate-fade-in { animation: fadeIn 0.5s ease-in-out; }
      @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
      .animate-pop-in { animation: popIn 0.3s ease-out; }
      @keyframes popIn { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }
      ::-webkit-scrollbar { width: 8px; height: 8px; }
      ::-webkit-scrollbar-track { background: #1B263B; border-radius: 10px; }
      ::-webkit-scrollbar-thumb { background: #415A77; border-radius: 10px; }
      ::-webkit-scrollbar-thumb:hover { background: #778DA9; }
      * { scrollbar-width: thin; scrollbar-color: #415A77 #1B263B; }
    </style>

    <!-- Tailwind CSS from CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              'brand-primary': '#0D1B2A',
              'brand-secondary': '#1B263B',
              'brand-tertiary': '#415A77',
              'brand-accent': '#778DA9',
              'brand-light': '#E0E1DD',
              'brand-cta': '#3B82F6',
              'brand-cta-hover': '#2563EB',
              'brand-success': '#10B981',
              'brand-danger': '#EF4444',
            },
          },
        },
      };
    </script>

    <!-- Import Map to resolve bare module specifiers for React -->
    <script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@18.2.0",
    "react/jsx-runtime": "https://esm.sh/react@18.2.0/jsx-runtime",
    "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
    "react-dom/": "https://esm.sh/react-dom@18.2.0/",
    "react/": "https://esm.sh/react@18.2.0/"
  }
}
</script>
  </head>
  <body class="bg-brand-primary text-brand-light">
    <div id="root"></div>

    <!-- Babel Standalone for in-browser transpilation of TSX/JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Main application script -->
    <script type="text/babel" data-type="module">
      import React, { useState, useEffect, useCallback, useMemo, useRef, createContext, useContext } from 'react';
      import ReactDOM from 'react-dom/client';

      // --- INLINED: i18n ---
      const translations = {
        es: {
          header_title: 'Aplicación PLAYTEST', header_subtitle: 'La forma más divertida de estudiar', language: 'Idioma', english: 'Inglés', spanish: 'Español',
          all_blocks_return: 'Volver',
          generic_cancel: 'Cancelar', error: 'Error', loading: 'Cargando...', delete: 'Eliminar',
          footer_text: '© 2024 PLAYTEST. Todos los derechos reservados.',
          game_question: 'Pregunta', game_of: 'de', game_score: 'Puntuación',
          game_results_title: '¡Partida Terminada!', game_results_summary: 'Llegaste hasta el Nivel {level}.',
          game_button_next: 'Siguiente Pregunta', game_button_finish: 'Finalizar', game_button_play_again: 'Jugar de Nuevo',
          game_button_dashboard: 'Volver al Panel', game_feedback_correct: '¡Correcto!', game_feedback_incorrect: '¡Incorrecto!',
          game_select_answer: 'Selecciona una respuesta',
          game_setup_all_topics: 'Todos los temas',
          game_finish_confirm_title: '¿Finalizar Partida?', game_finish_confirm_message: '¿Seguro que quieres terminar la partida? Tu progreso actual se mostrará en la pantalla de resultados.',
          game_included_content: 'Contenido de la Partida',
          game_levels_desc: 'Supera los niveles acertando un número mínimo de preguntas. La dificultad aumenta con cada nivel. ¿Hasta dónde puedes llegar?',
          game_level: 'Nivel', game_level_cleared: '¡Nivel Superado!', game_level_failed: 'Nivel no superado',
          game_level_req: 'Necesitas {required} aciertos para pasar.',
          game_next_level: 'Siguiente Nivel',
          delete_question_prompt_confirm: 'SI', delete_question_prompt_cancel: 'NO',
        },
        en: {
          header_title: 'PLAYTEST App', header_subtitle: 'The most fun way to study', language: 'Language', english: 'English', spanish: 'Spanish',
          all_blocks_return: 'Return',
          generic_cancel: 'Cancel', error: 'Error', loading: 'Loading...', delete: 'Delete',
          footer_text: '© 2024 PLAYTEST. All rights reserved.',
          game_question: 'Question', game_of: 'of', game_score: 'Score',
          game_results_title: 'Game Over!', game_results_summary: 'You reached Level {level}.',
          game_button_next: 'Next Question', game_button_finish: 'Finish', game_button_play_again: 'Play Again',
          game_button_dashboard: 'Back to Dashboard', game_feedback_correct: 'Correct!', game_feedback_incorrect: 'Incorrect!',
          game_select_answer: 'Select an answer',
          game_setup_all_topics: 'All Topics',
          game_finish_confirm_title: 'Finish Game?', game_finish_confirm_message: 'Are you sure you want to end the game? Your current progress will be shown on the results screen.',
          game_included_content: 'Game Content',
          game_levels_desc: 'Pass the levels by answering a minimum number of questions correctly. The difficulty increases with each level. How far can you go?',
          game_level: 'Level', game_level_cleared: 'Level Cleared!', game_level_failed: 'Level Failed',
          game_level_req: 'You need {required} correct answers to pass.',
          game_next_level: 'Next Level',
          delete_question_prompt_confirm: 'YES', delete_question_prompt_cancel: 'NO',
        }
      };
      const LanguageContext = createContext();
      const LanguageProvider = ({ children }) => {
        const [language, setLanguage] = useState(() => localStorage.getItem('playtest_lang') || 'es');
        useEffect(() => { localStorage.setItem('playtest_lang', language); }, [language]);
        const t = useCallback((key, replacements = {}) => {
            let translation = translations[language][key] || translations['en'][key] || key;
            Object.keys(replacements).forEach(placeholder => {
                translation = translation.replace(`{${placeholder}}`, replacements[placeholder]);
            });
            return translation;
        }, [language]);
        return <LanguageContext.Provider value={{ language, setLanguage, t }}>{children}</LanguageContext.Provider>;
      };
      const useLanguage = () => useContext(LanguageContext);

      // --- INLINED: components/icons.tsx ---
      const BrainSalutingIcon = (props) => ( <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" {...props}> <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1.5 14.5c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zm3-4c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zm2.5-1.5c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zm1-5.5H11v-1h3.5c.83 0 1.5.67 1.5 1.5v1zM9.5 11c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2z"/> </svg> );
      const ChevronUpDownIcon = (props) => ( <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" {...props}> <path strokeLinecap="round" strokeLinejoin="round" d="M8.25 15L12 18.75 15.75 15m-7.5-6L12 5.25 15.75 9" /> </svg> );
      const CheckCircleIcon = (props) => ( <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor" {...props}> <path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clipRule="evenodd" /> </svg> );
      const XCircleIcon = (props) => ( <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor" {...props}> <path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clipRule="evenodd" /> </svg> );
      const ArrowUturnLeftIcon = (props) => ( <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" {...props}> <path strokeLinecap="round" strokeLinejoin="round" d="M9 15L3 9m0 0l6-6M3 9h12a6 6 0 010 12h-3" /> </svg> );
      const ArrowPathIcon = (props) => ( <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" {...props}> <path strokeLinecap="round" strokeLinejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 0011.667 0l3.181-3.183m-11.667-11.667a8.25 8.25 0 0111.667 0l3.181 3.183m-14.85-3.183L2.985 16.24z" /> </svg> );
      const FlagIcon = (props) => ( <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" {...props}><path strokeLinecap="round" strokeLinejoin="round" d="M3 3v1.5M3 21v-6m0 0l2.77-.693a9 9 0 016.208.682l.108.054a9 9 0 006.086.71l3.114-.732a48.524 48.524 0 01-.005-10.499l-3.11.732a9 9 0 01-6.085-.711l-.108-.054a9 9 0 00-6.208-.682L3 4.5M3 4.5v.75m0 10.5v.75m18-11.25v.75m0 10.5v.75M4.5 10.5a1.5 1.5 0 113 0v3a1.5 1.5 0 01-3 0v-3z" /></svg>);
      
      // --- INLINED: services/dataService.ts ---
      const DB_KEY = 'playtest_db_v3';
      const getDatabase = () => {
          const dbString = localStorage.getItem(DB_KEY);
          return dbString ? JSON.parse(dbString) : { users: [], globalBlocks: [], globalQuestions: [], userProfiles: {} };
      };
      const saveDatabase = (db) => localStorage.setItem(DB_KEY, JSON.stringify(db));
      const simulateDelay = (data, delay = 50) => new Promise(resolve => setTimeout(() => resolve(JSON.parse(JSON.stringify(data))), delay));
      const dataService = {
          fetchAllBlocks: async () => {
              const db = getDatabase();
              return simulateDelay((db.globalBlocks || []).map(b => ({
                  ...b,
                  questions: (db.globalQuestions || []).filter(q => q.bloqueId === b.id),
              })));
          },
          fetchGame: async (gameId) => {
              const db = getDatabase();
              const game = (db.globalGames || []).find(g => g.id === gameId);
              return simulateDelay(game);
          },
           updateUserStats: async (userId, gameId, gameResults, gameModeName) => {
              const db = getDatabase();
              const profile = db.userProfiles[userId];
              if (!profile) return;
      
              if (!profile.stats) profile.stats = {};
              if (!profile.answerHistory) profile.answerHistory = [];
              if (!profile.stats.consolidation) {
                  profile.stats.consolidation = { byQuestion: {}, byTopic: {}, byBlock: {} };
              }
              
              for (const answer of gameResults.answers) {
                  const { blockId, questionId, topicName, result, responseTime } = answer;
                  if (!blockId || !questionId) continue;
                  
                  profile.answerHistory.unshift({
                      gameId, questionId, blockId, topicName, result,
                      responseTime, timestamp: new Date().toISOString(),
                  });
              }

              const allGlobalQuestions = db.globalQuestions || [];
              const blockIdsInGame = new Set(gameResults.answers.map(a => a.blockId).filter(Boolean));

              for (const blockId of blockIdsInGame) {
                  const questionsInBlock = allGlobalQuestions.filter(q => q.bloqueId === blockId);
                  if (questionsInBlock.length === 0) continue;

                  const correctlyAnsweredIdsInBlock = new Set(
                      profile.answerHistory
                          .filter(h => h.blockId === blockId && h.result === 'ACIERTO')
                          .map(h => h.questionId)
                  );
                  const blockConsolidation = (correctlyAnsweredIdsInBlock.size / questionsInBlock.length) * 100;
                  profile.stats.consolidation.byBlock[blockId] = blockConsolidation;

                  const topicsInBlock = [...new Set(questionsInBlock.map(q => q.tema).filter(Boolean))];
                  
                  for (const topicName of topicsInBlock) {
                      const questionsInTopic = questionsInBlock.filter(q => q.tema === topicName);
                      if (questionsInTopic.length === 0) continue;

                      const correctlyAnsweredIdsInTopic = new Set(
                          profile.answerHistory
                              .filter(h => h.blockId === blockId && h.topicName === topicName && h.result === 'ACIERTO')
                              .map(h => h.questionId)
                      );
                      const topicConsolidation = (correctlyAnsweredIdsInTopic.size / questionsInTopic.length) * 100;
                      const topicKey = `${blockId}_${topicName}`;
                      profile.stats.consolidation.byTopic[topicKey] = topicConsolidation;
                  }
              }
      
              if (!profile.gameHistory) {
                  profile.gameHistory = [];
              }
              const correct = gameResults.answers.filter(a => a.result === 'ACIERTO' || a.isCorrect === true).length;
              const incorrect = gameResults.answers.filter(a => a.result === 'FALLO' || a.isCorrect === false).length;
              
              const blockIds = [...new Set(gameResults.answers.map(a => a.blockId))];
              const blockNames = (db.globalBlocks || [])
                  .filter(b => blockIds.includes(b.id))
                  .map(b => b.nombreCorto)
                  .join(', ');

              const historyEntry = {
                  gameId,
                  blockName: blockNames || 'N/A',
                  mode: gameModeName,
                  correct,
                  incorrect,
                  date: new Date().toISOString(),
              };

              if(gameResults.opponent) historyEntry.opponent = gameResults.opponent;
              if(gameResults.score !== undefined) historyEntry.score = gameResults.score;

              profile.gameHistory.unshift(historyEntry);
              if (profile.gameHistory.length > 10) {
                  profile.gameHistory = profile.gameHistory.slice(0, 10);
              }

              saveDatabase(db);
              return simulateDelay({ success: true });
          },
      };

      // --- INLINED: auth ---
      const UserContext = createContext();
      const useUser = () => useContext(UserContext);

      const UserProvider = ({ children }) => {
        const [currentUser, setCurrentUser] = useState(null);
        const [isLoading, setIsLoading] = useState(true);

        useEffect(() => {
          try {
            const sessionString = localStorage.getItem('playtest_session');
            if (sessionString) {
              const session = JSON.parse(sessionString);
              if (session && session.userId) {
                const db = getDatabase();
                const user = (db.users || []).find(u => u.id === session.userId);
                if (user) {
                  setCurrentUser(user);
                } else {
                  localStorage.removeItem('playtest_session');
                }
              }
            }
          } catch (e) {
            console.error("Failed to parse session, clearing it.", e);
            localStorage.removeItem('playtest_session');
          }
          setIsLoading(false);
        }, []);

        if (isLoading) {
          return (
             <div className="flex justify-center items-center h-screen"> <svg className="animate-spin h-10 w-10 text-brand-cta" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"> <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle> <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path> </svg> </div>
          )
        }

        if (!currentUser) {
           window.location.href = 'index.html';
           return null;
        }

        return (
          <UserContext.Provider value={{ currentUser }}>
            {children}
          </UserContext.Provider>
        );
      }

      // --- INLINED: components ---
       const ConfirmationDialog = ({ title, message, confirmText, cancelText, onConfirm, onCancel, danger = false }) => (
        <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 animate-fade-in" onClick={onCancel}>
          <div className={`bg-brand-secondary rounded-xl shadow-2xl w-full max-w-sm m-4 border ${danger ? 'border-brand-danger/50' : 'border-brand-tertiary'} p-6 text-center`} onClick={e => e.stopPropagation()}>
              <h4 className="text-xl font-bold text-brand-light">{title}</h4>
              <p className="text-brand-accent my-4">{message}</p>
              <div className="flex justify-center gap-4 mt-6">
                  <button onClick={onCancel} className="py-2 px-6 rounded-lg bg-brand-tertiary hover:bg-brand-accent text-brand-light font-bold transition-colors">{cancelText}</button>
                  <button onClick={onConfirm} className={`py-2 px-6 rounded-lg font-bold transition-colors text-white ${danger ? 'bg-brand-danger hover:bg-red-500' : 'bg-brand-cta hover:bg-brand-cta-hover'}`}>{confirmText}</button>
              </div>
          </div>
        </div>
      );
      
      const Header = () => {
        const { language, setLanguage, t } = useLanguage();
        const [isDropdownOpen, setIsDropdownOpen] = useState(false);
        const dropdownRef = useRef(null);
        useEffect(() => { const handleClickOutside = (e) => { if (dropdownRef.current && !dropdownRef.current.contains(e.target)) setIsDropdownOpen(false); }; document.addEventListener("mousedown", handleClickOutside); return () => document.removeEventListener("mousedown", handleClickOutside); }, [dropdownRef]);
        return (
          <header className="bg-brand-secondary shadow-lg"><div className="container mx-auto px-4 sm:px-6 lg:px-8"><div className="flex items-center justify-between h-16">
              <div className="flex items-center space-x-3"><BrainSalutingIcon className="h-8 w-8 text-brand-cta" /><h1 className="text-xl md:text-2xl font-bold tracking-wider text-brand-light">{t('header_title')} <span className="font-light text-brand-accent hidden sm:inline">{t('header_subtitle')}</span></h1></div>
              <div className="relative" ref={dropdownRef}><button onClick={() => setIsDropdownOpen(!isDropdownOpen)} className="flex items-center gap-2 text-brand-accent hover:text-brand-light transition-colors p-2 rounded-md"><span className="font-semibold">{language.toUpperCase()}</span><ChevronUpDownIcon className="h-5 w-5" /></button>
                {isDropdownOpen && (<div className="absolute right-0 mt-2 w-32 bg-brand-primary rounded-md shadow-lg z-20 ring-1 ring-black ring-opacity-5"><div className="py-1"><a href="#" onClick={(e)=>{e.preventDefault();setLanguage('es');setIsDropdownOpen(false);}} className="block px-4 py-2 text-sm text-brand-light hover:bg-brand-tertiary">{t('spanish')}</a><a href="#" onClick={(e)=>{e.preventDefault();setLanguage('en');setIsDropdownOpen(false);}} className="block px-4 py-2 text-sm text-brand-light hover:bg-brand-tertiary">{t('english')}</a></div></div>)}
              </div>
          </div></div></header>
        );
      };

      const ByLevelsGameComponent = ({ questions, game, blocks }) => {
          const { t } = useLanguage();
          const { currentUser } = useUser();
          
          const levelsConfig = useMemo(() => [
            { level: 1, difficulty: 1, questionsPerLevel: 5, passRequirement: 3 },
            { level: 2, difficulty: 2, questionsPerLevel: 5, passRequirement: 3 },
            { level: 3, difficulty: 3, questionsPerLevel: 5, passRequirement: 4 },
            { level: 4, difficulty: 4, questionsPerLevel: 5, passRequirement: 4 },
            { level: 5, difficulty: 5, questionsPerLevel: 5, passRequirement: 5 },
          ], []);

          const questionsByLevel = useMemo(() => {
            return levelsConfig.map(levelConf => {
              const levelQuestions = questions
                .filter(q => q.dificultad === levelConf.difficulty)
                .sort(() => 0.5 - Math.random()) // Shuffle
                .slice(0, levelConf.questionsPerLevel);
              return { ...levelConf, questions: levelQuestions };
            }).filter(level => level.questions.length >= level.passRequirement); // Only include levels that are possible to pass
          }, [questions, levelsConfig]);
          
          const [currentLevelIndex, setCurrentLevelIndex] = useState(0);
          const [questionInLevelIndex, setQuestionInLevelIndex] = useState(0);
          const [levelAnswers, setLevelAnswers] = useState([]);
          const [allUserAnswers, setAllUserAnswers] = useState([]);
          const [gameState, setGameState] = useState('playing'); // playing, level_transition, finished
          const [selectedAnswerIndex, setSelectedAnswerIndex] = useState(null);
          const [isAnswered, setIsAnswered] = useState(false);
          const [isConfirmingFinish, setIsConfirmingFinish] = useState(false);
          const [questionStartTime, setQuestionStartTime] = useState(Date.now());

          const currentLevel = questionsByLevel[currentLevelIndex];
          const currentQuestion = currentLevel?.questions[questionInLevelIndex];

          useEffect(() => {
            if (gameState === 'finished' && currentUser && allUserAnswers.length > 0) {
                const answersForStats = allUserAnswers.map(answer => ({
                    ...answer,
                    result: answer.isCorrect ? 'ACIERTO' : 'FALLO',
                }));
                 const gameResults = {
                    answers: answersForStats
                };
                dataService.updateUserStats(currentUser.id, game.id, gameResults, game.mode);
            }
          }, [gameState, currentUser, allUserAnswers, game]);
          
           useEffect(() => {
            setQuestionStartTime(Date.now());
          }, [currentLevelIndex, questionInLevelIndex]);


          const handleAnswerSelect = (answerIndex) => {
              if (isAnswered) return;
              const responseTime = (Date.now() - questionStartTime) / 1000;
              setSelectedAnswerIndex(answerIndex);
              setIsAnswered(true);
              const isCorrect = currentQuestion.respuestas[answerIndex].esCorrecta;
              setLevelAnswers(prev => [...prev, { isCorrect }]);
              setAllUserAnswers(prev => [...prev, { 
                questionId: currentQuestion.id,
                isCorrect,
                blockId: currentQuestion.blockId,
                topicName: currentQuestion.tema,
                responseTime,
               }]);
          };

          const handleNext = () => {
              if (questionInLevelIndex < currentLevel.questions.length - 1) {
                  setQuestionInLevelIndex(prev => prev + 1);
                  setSelectedAnswerIndex(null);
                  setIsAnswered(false);
              } else {
                  // Level finished, go to transition screen
                  setGameState('level_transition');
              }
          };
          
          const handleFinish = () => {
              setGameState('finished');
              setIsConfirmingFinish(false);
          };

          const handleNextLevel = () => {
            if(currentLevelIndex < questionsByLevel.length - 1) {
              setCurrentLevelIndex(prev => prev + 1);
              setQuestionInLevelIndex(0);
              setLevelAnswers([]);
              setSelectedAnswerIndex(null);
              setIsAnswered(false);
              setGameState('playing');
            } else {
              // All levels cleared
              setGameState('finished');
            }
          };
          
          const includedContent = useMemo(() => {
              if (!game || !game.config || !blocks) return [];
              return Object.entries(game.config).map(([blockId, blockConfig]) => {
                  const block = blocks.find(b => b.id === blockId);
                  if (!block) return null;
                  const topics = blockConfig.topics === 'all'
                      ? t('game_setup_all_topics')
                      : blockConfig.topics.join(', ');
                  return { blockName: block.nombreCorto, topics };
              }).filter(Boolean);
          }, [game, blocks, t]);

          if(questionsByLevel.length === 0) {
            return <div className="text-center p-8 text-brand-accent">No hay suficientes preguntas de diferentes dificultades para crear los niveles.</div>
          }
          
          if (gameState === 'level_transition') {
            const correctAnswersInLevel = levelAnswers.filter(a => a.isCorrect).length;
            const passed = correctAnswersInLevel >= currentLevel.passRequirement;
            if(!passed) {
              // Defer the state update to avoid updating during render
              setTimeout(() => setGameState('finished'), 0);
            }
            return (
              <div className="max-w-2xl mx-auto text-center animate-fade-in p-8 bg-brand-secondary rounded-xl">
                <h2 className={`text-4xl font-bold mb-4 ${passed ? 'text-brand-success' : 'text-brand-danger'}`}>
                    {passed ? t('game_level_cleared') : t('game_level_failed')}
                </h2>
                <p className="text-brand-accent mb-8">Completaste el Nivel {currentLevel.level} con {correctAnswersInLevel}/{currentLevel.questions.length} aciertos.</p>
                {passed ? (
                    <button onClick={handleNextLevel} className="bg-brand-cta hover:bg-brand-cta-hover text-white font-bold py-3 px-6 rounded-lg transition-colors">
                      {currentLevelIndex < questionsByLevel.length - 1 ? t('game_next_level') : t('game_button_finish')}
                    </button>
                ) : (
                    <button onClick={() => window.location.reload()} className="bg-brand-tertiary hover:bg-brand-accent text-white font-bold py-3 px-6 rounded-lg transition-colors">
                        {t('game_button_play_again')}
                    </button>
                )}
              </div>
            );
          }

          if (gameState === 'finished') {
              return (
                  <div className="max-w-2xl mx-auto text-center animate-fade-in p-8 bg-brand-secondary rounded-xl">
                      <h2 className="text-4xl font-bold text-brand-light mb-4">{t('game_results_title')}</h2>
                      <p className="text-brand-accent mb-8">{t('game_results_summary', { level: currentLevel.level })}</p>
                       <div className="flex justify-center gap-4">
                          <button onClick={() => window.location.reload()} className="flex items-center gap-2 bg-brand-tertiary hover:bg-brand-accent text-brand-light font-bold py-3 px-6 rounded-lg transition-colors">
                              <ArrowPathIcon className="h-5 w-5" />{t('game_button_play_again')}
                          </button>
                          <button onClick={() => window.location.href = 'index.html'} className="flex items-center gap-2 bg-brand-cta hover:bg-brand-cta-hover text-white font-bold py-3 px-6 rounded-lg transition-colors">
                              <ArrowUturnLeftIcon className="h-5 w-5" />{t('game_button_dashboard')}
                          </button>
                      </div>
                  </div>
              );
          }

          if (!currentQuestion) return <div className="text-center p-8">{t('loading')}</div>

          return (
              <div className="max-w-4xl mx-auto animate-fade-in">
                   {isConfirmingFinish && (
                      <ConfirmationDialog
                          title={t('game_finish_confirm_title')}
                          message={t('game_finish_confirm_message')}
                          confirmText={t('game_button_finish')}
                          cancelText={t('generic_cancel')}
                          onConfirm={handleFinish}
                          onCancel={() => setIsConfirmingFinish(false)}
                          danger={true}
                      />
                  )}
                  <div className="mb-6 p-4 bg-brand-secondary/50 rounded-lg border border-brand-tertiary/50">
                     <div className="flex justify-between items-center mb-3">
                        <h2 className="text-2xl font-bold text-brand-light">{game.mode}</h2>
                        <button onClick={() => setIsConfirmingFinish(true)} className="flex items-center gap-2 text-sm bg-brand-danger/80 hover:bg-brand-danger text-white font-semibold py-2 px-4 rounded-lg transition-colors">
                              <FlagIcon className="h-5 w-5" />
                              {t('game_button_finish')}
                        </button>
                      </div>
                      <p className="text-sm text-brand-accent mb-3 italic">{t('game_levels_desc')}</p>
                      <div className="text-sm text-brand-accent space-y-1 mt-2 border-t border-brand-tertiary/20 pt-2">
                          <h3 className="font-semibold text-brand-light mb-2">{t('game_included_content')}:</h3>
                          {includedContent.map(item => (
                              <div key={item.blockName}><span className="font-medium text-brand-accent">{item.blockName}:</span> <span className="italic text-brand-tertiary">{item.topics}</span></div>
                          ))}
                      </div>
                  </div>

                  <div className="bg-brand-secondary p-6 sm:p-8 rounded-xl shadow-2xl">
                      <div className="flex justify-between items-center mb-4 text-brand-light">
                          <h3 className="font-bold text-brand-cta">{t('game_level')} {currentLevel.level}</h3>
                          <p className="text-sm text-brand-accent">{t('game_level_req', {required: currentLevel.passRequirement})}</p>
                          <h3 className="font-bold">{t('game_score')}: <span className="text-brand-success">{levelAnswers.filter(a => a.isCorrect).length}</span>/{questionInLevelIndex + 1}</h3>
                      </div>

                      <div className="w-full bg-brand-primary rounded-full h-2.5 mb-6">
                        <div className="bg-brand-cta h-2.5 rounded-full transition-all duration-300" style={{ width: `${((questionInLevelIndex + 1) / currentLevel.questions.length) * 100}%` }}></div>
                      </div>
                      
                      <div className="bg-brand-primary p-6 rounded-lg mb-6">
                          <p className="text-xl sm:text-2xl font-semibold text-brand-light leading-relaxed text-center">{currentQuestion.textoPregunta}</p>
                      </div>
                      
                      <fieldset className="grid grid-cols-1 md:grid-cols-2 gap-4">
                          <legend className="sr-only">{t('game_select_answer')}</legend>
                          {currentQuestion.respuestas.map((answer, index) => {
                              const isCorrect = answer.esCorrecta;
                              const isSelected = selectedAnswerIndex === index;
                              let buttonClass = 'bg-brand-tertiary hover:bg-brand-accent';
                              if (isAnswered) {
                                  if (isCorrect) buttonClass = 'bg-brand-success/80 ring-2 ring-brand-success';
                                  else if (isSelected) buttonClass = 'bg-brand-danger/80 ring-2 ring-brand-danger';
                                  else buttonClass = 'bg-brand-tertiary opacity-60';
                              }
                              return (
                                  <button key={index} onClick={() => handleAnswerSelect(index)} disabled={isAnswered} className={`w-full text-left p-4 rounded-lg text-brand-light font-medium transition-all duration-300 transform disabled:scale-100 disabled:cursor-not-allowed ${!isAnswered && 'hover:scale-105'} ${buttonClass}`}>
                                      {answer.textoRespuesta}
                                  </button>
                              );
                          })}
                      </fieldset>

                      {isAnswered && (
                          <div className="mt-6 p-4 bg-brand-primary rounded-lg text-center animate-pop-in">
                              <h3 className={`text-xl font-bold ${levelAnswers[levelAnswers.length-1]?.isCorrect ? 'text-brand-success' : 'text-brand-danger'}`}>
                                  {levelAnswers[levelAnswers.length-1]?.isCorrect ? t('game_feedback_correct') : t('game_feedback_incorrect')}
                              </h3>
                              {currentQuestion.explicacionRespuesta && <p className="text-sm text-brand-accent mt-2">{currentQuestion.explicacionRespuesta}</p>}
                              <button onClick={handleNext} className="mt-4 bg-brand-cta hover:bg-brand-cta-hover text-white font-bold py-2 px-8 rounded-lg transition-colors">
                                  {t('game_button_next')}
                              </button>
                          </div>
                      )}
                  </div>
              </div>
          );
      };

      const ByLevelsGamePageContent = () => {
          const { t } = useLanguage();
          const { currentUser } = useUser();
          const [game, setGame] = useState(null);
          const [blocks, setBlocks] = useState([]);
          const [isLoading, setIsLoading] = useState(true);
          const [error, setError] = useState(null);
          const [gameId, setGameId] = useState(null);

          useEffect(() => {
              const params = new URLSearchParams(window.location.search);
              const id = params.get('gameId');
              if (id) setGameId(id);
              else { setError("No game ID provided."); setIsLoading(false); }
          }, []);
          
          useEffect(() => {
              if (!gameId || !currentUser) return;
              const loadData = async () => {
                  try {
                       const [fetchedGame, fetchedBlocks] = await Promise.all([ 
                          dataService.fetchGame(gameId), 
                          dataService.fetchAllBlocks() 
                        ]);
                      if (!fetchedGame) throw new Error("Game not found.");
                      setGame(fetchedGame);
                      setBlocks(fetchedBlocks);
                  } catch (err) { setError(err.message);
                  } finally { setIsLoading(false); }
              };
              loadData();
          }, [gameId, currentUser]);
          
          const gameQuestions = useMemo(() => {
              if (!game || !game.config || !blocks || blocks.length === 0) return [];
              let questions = [];
              for (const [blockId, blockConfig] of Object.entries(game.config)) {
                  const block = blocks.find(b => b.id === blockId);
                  if (!block || !block.questions) continue;
                  const questionsWithMeta = block.questions.map(q => ({...q, blockId: block.id }));
                  if (blockConfig.topics === 'all') {
                    questions.push(...questionsWithMeta);
                  } else if (Array.isArray(blockConfig.topics)) {
                    questions.push(...questionsWithMeta.filter(q => blockConfig.topics.includes(q.tema)));
                  }
              }
              return questions;
          }, [game, blocks]);

          const renderContent = () => {
              if (isLoading) { return <div className="flex justify-center items-center h-64"><svg className="animate-spin h-10 w-10 text-brand-cta" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle><path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg></div>; }
              if (error) { return <div className="text-center text-brand-danger bg-red-500/10 p-4 rounded-lg">{t('error')}: {error}</div>; }
              if (gameQuestions.length === 0) { return <div className="text-center text-brand-accent p-8">No questions found for this game configuration.</div> }
              return <ByLevelsGameComponent questions={gameQuestions} game={game} blocks={blocks} />;
          };

          return (
              <div className="min-h-screen flex flex-col">
                  <Header />
                  <main className="flex-grow p-4 sm:p-6 lg:p-8">{renderContent()}</main>
                  <footer className="text-center p-4 text-xs text-brand-accent"><p>{t('footer_text')}</p></footer>
              </div>
          );
      };

      const ByLevelsGamePage = () => (
          <UserProvider>
            <ByLevelsGamePageContent />
          </UserProvider>
      );

      // --- App Entry Point ---
      const root = ReactDOM.createRoot(document.getElementById('root'));
      root.render(
        <React.StrictMode>
          <LanguageProvider><ByLevelsGamePage /></LanguageProvider>
        </React.StrictMode>
      );
    </script>
    <noscript>This application requires JavaScript to run.</noscript>
  </body>
</html>